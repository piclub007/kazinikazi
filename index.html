<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Kazi ni Kazi - Rwanda's Job Marketplace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="sticky-header">
    <div class="logo" onclick="location.href='/'">
      <i class="fas fa-briefcase"></i>
      <span>Kazi</span> ni Kazi
    </div>
    <div class="header-actions">
      <button class="btn-icon" id="authBtn" onclick="showAuthModal()"><i class="fas fa-user"></i></button>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Find work. Hire talent.<br><span>In Rwanda.</span></h1>
      <p>Connect with verified workers and companies in your area</p>
    </section>

    <div class="search-section">
      <div class="search-tabs">
        <button class="search-tab active" onclick="filterBrowse('workers')">Workers</button>
        <button class="search-tab" onclick="filterBrowse('companies')">Companies</button>
      </div>
      <div class="search-bar">
        <select id="filterDistrict" class="search-select">
          <option value="">All Districts</option>
        </select>
        <select id="filterCategory" class="search-select">
          <option value="">All Categories</option>
        </select>
        <button class="search-btn" onclick="applyFilters()">
          <i class="fas fa-search"></i> Search
        </button>
      </div>
    </div>

    <h2 class="section-title" id="resultsTitle">Popular Workers</h2>
    <div id="resultsGrid" class="card-grid"></div>
    <div id="loadingSpinner" class="spinner hidden"></div>
  </main>

  <!-- Auth Modal -->
  <div id="authModal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="modal-header">
        <h2>Join Kazi ni Kazi</h2>
        <p>Select your account type</p>
      </div>
      <div class="modal-body">
        <div class="account-grid">
          <div class="account-card" onclick="selectRole('worker')" id="role-worker">
            <i class="fas fa-hard-hat account-icon"></i>
            <h3>Worker</h3>
            <p>Find jobs, showcase skills, get hired</p>
          </div>
          <div class="account-card" onclick="selectRole('company')" id="role-company">
            <i class="fas fa-building account-icon"></i>
            <h3>Company</h3>
            <p>Post jobs, hire workers, build your team</p>
          </div>
          <div class="account-card" onclick="selectRole('user')" id="role-user">
            <i class="fas fa-user account-icon"></i>
            <h3>User</h3>
            <p>Browse and hire for personal projects</p>
          </div>
        </div>

        <form id="authForm" onsubmit="handleAuth(event)" class="hidden">
          <h3 id="authFormTitle">Create Worker Account</h3>
          <div class="form-group">
            <input type="text" id="fullName" placeholder="Full name" class="form-input" required>
          </div>
          <div class="form-group" id="uniqueNameGroup">
            <input type="text" id="uniqueName" placeholder="Unique username" class="form-input">
            <small class="form-help">One per device, cannot change</small>
          </div>
          <div class="form-group">
            <input type="email" id="email" placeholder="Email" class="form-input" required>
          </div>
          <div class="form-group">
            <input type="password" id="password" placeholder="Password (min 6 chars)" class="form-input" required>
          </div>
          <button type="submit" class="btn-primary" id="authSubmit">Create Account</button>
          <p class="text-center mt-4">
            <a href="#" onclick="toggleAuthMode()">Already have an account? Sign in</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase config
    import { auth, db, deviceId, showToast } from './firebase-cfg.js';
    import { 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
    import { 
      collection, getDocs, query, where, doc, setDoc 
    } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

    // State
    let selectedRole = null;
    let isLogin = false;
    let currentFilter = 'workers';

    // Check auth state
    onAuthStateChanged(auth, (user) => {
      const authBtn = document.getElementById('authBtn');
      if (user) {
        authBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i>';
        authBtn.onclick = () => location.href = 'dashboard.html';
      } else {
        authBtn.innerHTML = '<i class="fas fa-user"></i>';
        authBtn.onclick = showAuthModal;
      }
    });

    // Load filters
    async function loadFilters() {
      try {
        const districtsSnap = await getDocs(collection(db, 'districts'));
        const categoriesSnap = await getDocs(collection(db, 'categories'));
        
        const districtSelect = document.getElementById('filterDistrict');
        const categorySelect = document.getElementById('filterCategory');
        
        districtsSnap.forEach(d => {
          districtSelect.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
        });
        
        categoriesSnap.forEach(c => {
          categorySelect.innerHTML += `<option value="${c.id}">${c.data().name}</option>`;
        });
      } catch (error) {
        console.error('Error loading filters:', error);
      }
    }

    // Load profiles
    async function loadProfiles(type = 'workers') {
      const grid = document.getElementById('resultsGrid');
      const spinner = document.getElementById('loadingSpinner');
      const title = document.getElementById('resultsTitle');
      
      spinner.classList.remove('hidden');
      grid.innerHTML = '';
      
      title.textContent = type === 'workers' ? 'Popular Workers' : 'Trusted Companies';
      currentFilter = type;
      
      try {
        const role = type === 'workers' ? 'worker' : 'company';
        let q = query(collection(db, 'users'), where('role', '==', role));
        
        // Apply district filter if selected
        const district = document.getElementById('filterDistrict').value;
        if (district) {
          q = query(q, where('district', '==', district));
        }
        
        // Apply category filter for workers
        const category = document.getElementById('filterCategory').value;
        if (category && role === 'worker') {
          q = query(q, where('jobCategory', '==', category));
        }
        
        const snap = await getDocs(q);
        
        if (snap.empty) {
          grid.innerHTML = '<p class="text-center" style="grid-column: 1/-1; color: var(--gray-500);">No profiles found</p>';
        } else {
          snap.forEach(doc => {
            const data = doc.data();
            grid.innerHTML += `
              <div class="card" onclick="location.href='profile.html?id=${doc.id}'">
                <div class="card-image">
                  <img src="${data.profilePicture || data.logo || 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=400'}" loading="lazy">
                  ${data.verified ? '<span class="card-badge"><i class="fas fa-check-circle card-verified"></i></span>' : ''}
                </div>
                <div class="card-content">
                  <div class="card-title">${data.fullName || data.companyName}</div>
                  <div class="card-subtitle">${data.district || ''}</div>
                  <div class="card-footer">
                    <span class="card-rating">
                      <i class="fas fa-star"></i> ${(data.avgRating || 0).toFixed(1)}
                    </span>
                    ${data.status ? `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>` : ''}
                  </div>
                </div>
              </div>
            `;
          });
        }
      } catch (error) {
        showToast('Error loading profiles', 'error');
      } finally {
        spinner.classList.add('hidden');
      }
    }

    // Auth functions
    window.showAuthModal = () => {
      document.getElementById('authModal').classList.remove('hidden');
    };

    window.selectRole = (role) => {
      selectedRole = role;
      document.querySelectorAll('.account-card').forEach(c => c.classList.remove('selected'));
      document.getElementById(`role-${role}`).classList.add('selected');
      
      const form = document.getElementById('authForm');
      form.classList.remove('hidden');
      document.getElementById('authFormTitle').textContent = 
        `Create ${role.charAt(0).toUpperCase() + role.slice(1)} Account`;
      
      document.getElementById('uniqueNameGroup').style.display = role === 'user' ? 'block' : 'none';
    };

    window.handleAuth = async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const fullName = document.getElementById('fullName').value;
      const uniqueName = document.getElementById('uniqueName')?.value;
      
      if (!email || !password) {
        showToast('Please fill all fields', 'error');
        return;
      }
      
      try {
        if (isLogin) {
          await signInWithEmailAndPassword(auth, email, password);
          showToast('Logged in!', 'success');
          document.getElementById('authModal').classList.add('hidden');
          location.href = 'dashboard.html';
        } else {
          if (!selectedRole) {
            showToast('Please select account type', 'error');
            return;
          }
          
          // Check unique name for users
          if (selectedRole === 'user' && uniqueName) {
            const q = query(collection(db, 'users'), where('uniqueName', '==', uniqueName));
            const snap = await getDocs(q);
            if (!snap.empty) {
              showToast('Username taken', 'error');
              return;
            }
          }
          
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          
          const userData = {
            uid: userCred.user.uid,
            email,
            role: selectedRole,
            deviceId: selectedRole === 'user' ? deviceId : null,
            createdAt: new Date().toISOString(),
            verified: false,
            boosted: false,
            avgRating: 0,
            reviewCount: 0,
            followerCount: 0
          };
          
          if (selectedRole === 'worker') {
            userData.fullName = fullName;
            userData.status = 'Available';
            userData.portfolioImages = [];
          } else if (selectedRole === 'company') {
            userData.companyName = fullName;
            userData.images = [];
          } else {
            userData.uniqueName = uniqueName;
          }
          
          await setDoc(doc(db, 'users', userCred.user.uid), userData);
          showToast('Account created!', 'success');
          document.getElementById('authModal').classList.add('hidden');
          location.href = 'dashboard.html';
        }
      } catch (error) {
        showToast(error.message, 'error');
      }
    };

    window.toggleAuthMode = () => {
      isLogin = !isLogin;
      document.getElementById('authSubmit').textContent = isLogin ? 'Sign In' : 'Create Account';
      document.getElementById('authFormTitle').textContent = isLogin ? 'Sign In' : 'Create Account';
      
      // Hide role selection in login mode
      document.querySelector('.account-grid').style.display = isLogin ? 'none' : 'grid';
    };

    window.filterBrowse = (type) => {
      document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      loadProfiles(type);
    };

    window.applyFilters = () => {
      loadProfiles(currentFilter);
    };

    // Initialize
    loadFilters();
    loadProfiles('workers');
  </script>
</body>
</html>
